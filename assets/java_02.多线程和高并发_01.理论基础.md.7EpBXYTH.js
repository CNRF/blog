import{_ as l,D as p,c as h,o as e,a3 as a,m as t,a as i,H as k,w as r}from"./chunks/framework.DpPtyC7-.js";const d="data:image/png;base64,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",F=JSON.parse('{"title":"01.理论基础","description":"","frontmatter":{"title":"01.理论基础","tags":["java","多线程"],"categories":["java","多线程"]},"headers":[],"relativePath":"java/02.多线程和高并发/01.理论基础.md","filePath":"java/02.多线程和高并发/01.理论基础.md","lastUpdated":1755174803000}'),E={name:"java/02.多线程和高并发/01.理论基础.md"};function c(o,s,g,y,b,u){const n=p("font");return e(),h("div",null,[s[3]||(s[3]=a(`<h2 id="为什么要有多线程" tabindex="-1">为什么要有多线程 <a class="header-anchor" href="#为什么要有多线程" aria-label="Permalink to &quot;为什么要有多线程&quot;">​</a></h2><p>众所周知，CPU、内存、I/O 设备的速度是有极大差异的，为了合理利用 CPU 的高性能，平衡这三者的速度差异，计算机体系结构、操作系统、编译程序都做出了贡献，主要体现为:</p><ul><li>CPU 增加了缓存，以均衡与内存的速度差异； ---&gt;可见性问题</li><li>操作系统增加了进程、线程，以分时复用 CPU，进而均衡 CPU 与 I/O 设备的速度差异；---&gt;原子性问题</li><li>编译程序优化指令执行次序，使得缓存能够得到更加合理地利用。---&gt;有序性问题</li></ul><h2 id="线程不安全示例" tabindex="-1">线程不安全示例 <a class="header-anchor" href="#线程不安全示例" aria-label="Permalink to &quot;线程不安全示例&quot;">​</a></h2><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ThreadUnSafeExample</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cnt </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        cnt</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cnt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ThreadUnSafe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[] </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">args</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">throws</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> InterruptedException {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> threadSize </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        ThreadUnSafeExample example </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ThreadUnSafeExample</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> CountDownLatch countDownLatch </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> CountDownLatch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(threadSize);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        ExecutorService executorService </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Executors.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">newCachedThreadPool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> threadSize; i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            executorService.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">execute</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                example.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                countDownLatch.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">countDown</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        countDownLatch.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        executorService.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">shutdown</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        System.out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(example.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><blockquote><p>理论上输出结果应该是100，但实际是小于100</p></blockquote><h2 id="并发问题根源-并发三要素" tabindex="-1">并发问题根源：并发三要素 <a class="header-anchor" href="#并发问题根源-并发三要素" aria-label="Permalink to &quot;并发问题根源：并发三要素&quot;">​</a></h2><ol><li>可见性：cpu缓存引起</li><li>原子性：分时复用引起</li><li>有序性：指令重排序</li></ol><h3 id="可见性-cpu缓存引起" tabindex="-1">可见性：cpu缓存引起 <a class="header-anchor" href="#可见性-cpu缓存引起" aria-label="Permalink to &quot;可见性：cpu缓存引起&quot;">​</a></h3><p>可见性：多个线程同时操作一个变量，一个线程修改之后，另一个需要立马可见</p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">//线程1逻辑</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">//线程2逻辑</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> j </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div>`,12)),t("p",null,[s[1]||(s[1]=i("假若执行线程1的是CPU1，执行线程2的是CPU2。 当线程1执行 i =10这句时，会先把i的初始值加载到CPU1的高速缓存中，然后赋值为10， 那么在CPU1的高速缓存当中i的值变为10了,",-1)),k(n,{color:"red"},{default:r(()=>s[0]||(s[0]=[i("却没有立即写入到主存当中",-1)])),_:1,__:[0]}),s[2]||(s[2]=i("。 同时线程2执行 j = i，它会先去主存读取i的值并加载到CPU2的缓存当中，注意此时内存当中i的值还是0， 那么就会使得j的值为0，而不是10.这就是可见性问题，线程1对变量i修改了之后，线程2没有立即看到线程1修改的值",-1))]),s[4]||(s[4]=a(`<h3 id="原子性问题" tabindex="-1">原子性问题 <a class="header-anchor" href="#原子性问题" aria-label="Permalink to &quot;原子性问题&quot;">​</a></h3><p>原子性：即一个操作或者多个操作 要么全部执行并且执行的过程不会被任何因素打断，要么就都不执行。类似事务</p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">//线程1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">//线程2</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>需要注意的是：i += 1需要三条 CPU 指令将变量 i 从内存读取到 CPU寄存器； 在CPU寄存器中执行 i + 1 操作；将最后的结果i写入内存（缓存机制导致可能写入的是 CPU 缓存而不是内存）。 由于CPU分时复用（线程切换）的存在，线程1执行了第一条指令后，就切换到线程2执行， 假如线程2执行了这三条指令后，再切换会线程1执行后续两条指令，将造成最后写到内存中的i值是2而不是3</p><h3 id="有序性-指令重排序" tabindex="-1">有序性: 指令重排序 <a class="header-anchor" href="#有序性-指令重排序" aria-label="Permalink to &quot;有序性: 指令重排序&quot;">​</a></h3><p>有序性：即程序执行的顺序按照代码的先后顺序执行</p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;              </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> flag </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;                </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">//语句1  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">flag </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;          </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">//语句2</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>上面代码定义了一个int型变量，定义了一个boolean类型变量，然后分别对两个变量进行赋值操作。从代码顺序上看，语句1是在语句2前面的， 那么JVM在真正执行这段代码的时候会保证语句1一定会在语句2前面执行吗? 不一定，为什么呢? 这里可能会发生指令重排序（Instruction Reorder）。 在执行程序时为了提高性能，编译器和处理器常常会对指令做重排序。 重排序分三种类型：</p><ol><li>编译器优化的重排序。编译器在不改变单线程程序语义的前提下，可以重新安排语句的执行顺序。</li><li>指令级并行的重排序。现代处理器采用了指令级并行技术（Instruction-Level Parallelism， ILP）来将多条指令重叠执行。如果不存在数据依赖性，处理器可以改变语句对应机器指令的执行顺序。</li><li>内存系统的重排序。由于处理器使用缓存和读 / 写缓冲区，这使得加载和存储操作看上去可能是在乱序执行。</li></ol><p>从 java 源代码到最终实际执行的指令序列，会分别经历下面三种重排序 <img src="`+d+'" alt="三重排序的执行过程"> 上述的 1 属于编译器重排序，2 和 3 属于处理器重排序。这些重排序都可能会导致多线程程序出现内存可见性问题。</p><ul><li>对于编译器，JMM 的编译器重排序规则会禁止特定类型的编译器重排序（不是所有的编译器重排序都要禁止）。</li><li>对于处理器重排序，JMM 的处理器重排序规则会要求 java 编译器在生成指令序列时，插入特定类型的内存屏障（memory barriers，intel 称之为 memory fence）指令， 通过内存屏障指令来禁止特定类型的处理器重排序（不是所有的处理器重排序都要禁止）。</li></ul><h2 id="java中解决并发问题方法-jmm-java内存模型" tabindex="-1">java中解决并发问题方法：JMM（Java内存模型） <a class="header-anchor" href="#java中解决并发问题方法-jmm-java内存模型" aria-label="Permalink to &quot;java中解决并发问题方法：JMM（Java内存模型）&quot;">​</a></h2><p>JMM本质上可以理解为，Java 内存模型规范了 JVM 如何提供按需禁用缓存和编译优化的方法。 具体来说，这些方法包括：<code>volatile</code>、<code>synchronized</code> 和 <code>final</code> 三个关键字Happens-Before 规则</p><p>相关详细见：</p><p><a href="./04.synchronize关键字">synchronize关键字</a></p><p><a href="./05.volatile关键字">volatile关键字</a></p><p><a href="./06.final关键字">final关键字</a></p>',17))])}const A=l(E,[["render",c]]);export{F as __pageData,A as default};
